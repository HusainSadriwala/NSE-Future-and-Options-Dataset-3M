----------------------------------------------------
CREATE TABLE IF NOT EXISTS dbo.EXCHANGES (
    EXCHANGE_ID INT PRIMARY KEY,
    EXCHANGE_NAME VARCHAR(10) NOT NULL UNIQUE );

-----------------------------------------------------
CREATE TABLE IF NOT EXISTS dbo.INSTRUMENTS (
    INSTRUMENT_ID INT PRIMARY KEY,
    INSTRUMENT_NAME VARCHAR(20) NOT NULL,
    SYMBOL VARCHAR(50) NOT NULL,
    EXCHANGE_ID INT NOT NULL,
    CONSTRAINT FK_INSTRUMENT_EXCHANGE
        FOREIGN KEY (EXCHANGE_ID)
        REFERENCES dbo.EXCHANGES (EXCHANGE_ID));

CREATE INDEX IF NOT EXISTS IDX_INSTRUMENTS_SYMBOL
ON dbo.INSTRUMENTS (SYMBOL);

CREATE INDEX IF NOT EXISTS IDX_INSTRUMENTS_EXCHANGE
ON dbo.INSTRUMENTS (EXCHANGE_ID);

------------------------------------------------------
CREATE TABLE IF NOT EXISTS dbo.EXPIRIES (
    EXPIRY_ID INT PRIMARY KEY,
    EXPIRY_DT DATE NOT NULL,
    STRIKE_PR NUMERIC(10,2),
    OPTION_TYP VARCHAR(5)
);

CREATE INDEX IF NOT EXISTS IDX_EXPIRIES_DT
ON dbo.EXPIRIES (EXPIRY_DT);

CREATE INDEX IF NOT EXISTS IDX_EXPIRIES_CHAIN
ON dbo.EXPIRIES (EXPIRY_DT, STRIKE_PR, OPTION_TYP);

--------------------------------------------------------
CREATE TABLE IF NOT EXISTS dbo.TRADES (
    TRADE_ID INT,
    INSTRUMENT_ID INT NOT NULL,
    EXPIRY_ID INT NOT NULL,
    TRADE_TIMESTAMP TIMESTAMP NOT NULL,
    OPEN NUMERIC(10,2),
    HIGH NUMERIC(10,2),
    LOW NUMERIC(10,2),
    CLOSE NUMERIC(10,2),
    SETTLE_PR NUMERIC(10,2),
    CONTRACTS INT,
    VAL_INLAKH NUMERIC(14,2),
    OPEN_INT BIGINT,
    CHG_IN_OI BIGINT,

    CONSTRAINT PK_TRADES
        PRIMARY KEY (TRADE_ID, TRADE_TIMESTAMP),

    CONSTRAINT FK_TRADES_INSTRUMENT
        FOREIGN KEY (INSTRUMENT_ID)
        REFERENCES dbo.INSTRUMENTS (INSTRUMENT_ID),

    CONSTRAINT FK_TRADES_EXPIRY
        FOREIGN KEY (EXPIRY_ID)
        REFERENCES dbo.EXPIRIES (EXPIRY_ID)

)
PARTITION BY RANGE (TRADE_TIMESTAMP);
CREATE INDEX IF NOT EXISTS BRIN_TRADES_TS
ON dbo.TRADES
USING BRIN (TRADE_TIMESTAMP);

----------------------------------------------------
